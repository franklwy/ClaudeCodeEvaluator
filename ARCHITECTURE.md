# 系统架构

## 1. 核心交互流程

```text
+--------+       +-------------+       +-------------+       +-------------+
|  用户   |       | Claude Code |       | MCP Server  |       |  评分核心    |
+---+----+       +------+------+       +------+------+       +------+------+
    |                   |                     |                     |
    | "帮我评分"         |                     |                     |
    +-----------------> |                     |                     |
    |                   | 1. 语义分析          |                     |
    |                   | 2. 匹配工具          |                     |
    |                   |                     |                     |
    |                   | call_tool()         |                     |
    |                   +-------------------> |                     |
    |                   |                     | 1. 路由分发          |
    |                   |                     | 2. 调用函数          |
    |                   |                     |                     |
    |                   |                     | evaluate_session()  |
    |                   |                     +-------------------> |
    |                   |                     |                     | 1. 读取日志
    |                   |                     |                     | 2. 计算指标
    |                   |                     |                     | 3. 生成报告
    |                   |                     |                     |
    |                   |                     |       返回结果       |
    |                   |                     | <-------------------+
    |                   |      JSON 响应       |                     |
    |                   | <-------------------+                     |
    |                   |                     |                     |
    |    渲染报告        |                     |                     |
    | <-----------------+                     |                     |
    |                   |                     |                     |
    v                   v                     v                     v
```

## 2. 内部数据处理流

```text
[ 输入: ~/.claude/projects/*.jsonl ]
               |
               v
      +-----------------+
      |  SessionParser  |  <-- 解析原始日志
      +--------+--------+
               |
               v
      +-----------------+
      |   SessionData   |  <-- 结构化对象
      +--------+--------+
               |
    +----------+-----------+----------------+
    |          |           |                |
    v          v           v                v
[完成度]    [时间分析]   [交互统计]      [代码质量]
(Keywd)    (Timestp)    (Count)      (Radon/Flake8)
    |          |           |                |
    +----------+-----------+----------------+
               |
               v
      +-----------------+
      |  ScoreReporter  |  <-- 汇总数据
      +--------+--------+
               |
               v
      [ 输出: Table / JSON / Markdown ]
```

## 3. 实现原理

### A. 通信层 (mcp_server.py)
采用 **FastMCP** 框架实现：
- **自动路由**：直接将 Python 函数映射为 MCP 工具，无需手动编写分发逻辑。
- **自动 Schema**：基于 Python 类型注解 (`type hints`) 自动生成工具描述文档。
- **协议封装**：自动处理 `stdio` 通信、异常捕获和日志重定向，防止 `print` 污染协议。

### B. 数据层 (cc_evaluator/parser)
- **路径发现**：自动定位 `~/.claude/projects/` 下的最新项目和会话。
- **日志清洗**：过滤掉 `thinking` 过程和中间状态，只保留关键对话和代码操作。

### C. 评分层 (cc_evaluator/evaluators)
采用插件式架构，每个维度独立计算：
1. **CompletionEvaluator**: 关键词匹配法判断首轮交互是否成功。
2. **TimeEvaluator**: 计算时间戳差值，评估响应延迟。
3. **CodeQualityEvaluator**: 提取会话中生成的代码，在临时文件中进行静态分析。
4. **PromptCountEvaluator**: 统计有效交互轮次。

